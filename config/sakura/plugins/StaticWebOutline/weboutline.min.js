// XML/JS/CSS統合アウトライン解析 v0.3.2 Moca
var g_opt={},g_bLoadPluginOption=true,solXml_Option="XmlEle2/ewpatiBjc",g_szOptHeader="XmlEle2/",g_nOptHeaderLen=8,g_bAddFuncModeTree=true;function AddFuncInfoBoth(g,f,n,q,m){g_bAddFuncModeTree?Outline.AddFuncInfo2(g,f+1,n,q):Outline.AddFuncInfo(g,f+1,n,m?m:0)}
function xml_OutlineExec(g,f,n,q,m,r){function B(l){var ea=true,fa=false,v={},W=ea,X=ea,Y=ea,Z=ea,$=ea,aa=ea,ba=ea,ca=ea,da=ea;if(l.substr(0,g_nOptHeaderLen)==g_szOptHeader){var T,ka=l.length;for(T=g_nOptHeaderLen;T<ka;T++)switch(l.charAt(T)){case "e":W=ea;break;case "E":W=fa;break;case "w":X=ea;break;case "W":X=fa;break;case "p":Y=ea;break;case "P":Y=fa;break;case "a":Z=ea;break;case "A":Z=fa;break;case "t":$=ea;break;case "T":$=fa;break;case "i":ba=ea;break;case "I":ba= fa;break;case "b":aa=ea;break;case "B":aa=fa;break;case "j":da=ea;break;case "J":da=fa;break;case "c":ca=ea;break;case "C":ca=fa;break}}v.e=W;v.w=X;v.p=Y;v.a=Z;v.t=$;v.b=aa;v.i=ba;v.c=ca;v.j=da;return v}function s(l){var v=l.charCodeAt(0);if(97<v&&v<122)return true;return I.test(l)}function i(l){if(1<=l.length){var v=l.charCodeAt(0);if(97<v&&v<122)return true;else if(v<128)return k.test(l);else if(v<1329)return h.test(l);return la.test(l)}return false}function w(l){return l<=32&& (9==l||32==l||10==l||13==l)}function K(l){return 32<l||9!=l&&32!=l&&10!=l&&13!=l}function L(l){return 55296<=l&&l<=56319}function D(l){if(ma["ht_"+l.toLowerCase()]==true)return true;return false}function A(l){return na.test(l)}var I=/^[A-Za-z:_\xC0-\xD6\xD8-\xF6\xF8\xFF\u0100-\u2010\u02BB-\u10fC\u2126\u212A\u212B\u212E\u2180-\u2182\u\u3041-\u3049\u30A1-\u30FA\u\u3105-\u312C\uAC00-\uD7A3\u4E00-\u9FA5\u3007\u3021-\u3029]$/,k=/^[\x2d-\x2e\x30-\x3a\x41-\x5a\x5f-\x5f\x61-\x7a]$/,h=/^[\xb7\xc0-\xd6\xd8-\xf6\xf8-\u0131\u0134-\u013e\u0141-\u0148\u014a-\u017e\u0180-\u01c3\u01cd-\u01f0\u01f4-\u01f5\u01fa-\u0217\u0250-\u02a8\u02bb-\u02c1\u02d0-\u02d1\u0300-\u0345\u0360\u0361\u0386-\u03d6\u03da-\u03f3\u0401-\u0486\u0490-\u04f9]$/, la=/^[\u0531-\u10f6\u1100-\u1e9b\u1ea0-\u1ef9\u1f00-\u1ffc\u20d0-\u20dc\u20e1\u2126\u212a-\u212b\u212e-\u212e\u2180-\u2182\u3005\u3007\u3021-\u302f\u3031-\u3035\u3041-\u3094\u3099-\u309a\u309d-\u309e\u30a1-\u30fa\u30fc-\u30fe\u3105-\u312c\u4e00-\u9fa5\uac00-\ud7a3]$/,ma={ht_area:true,ht_base:true,ht_basefont:true,ht_bgsound:true,ht_br:true,ht_col:true,ht_command:true,ht_embed:true,ht_frame:true,ht_hr:true,ht_img:true,ht_input:true,ht_isindex:true,ht_link:true,ht_meta:true,ht_param:true,ht_source:true, ht_wbr:true},na=/^[a-zA-Z0-9\.\-\:_]$/,o=B(solXml_Option,null),ea=o.e,M=o.w,Q=o.p,N=o.a,R=o.t,O=o.i,U=o.b;g=o.j;o=o.c;if(g_opt.ld){ea=g_opt.xe;M=g_opt.xw;Q=g_opt.xp;N=g_opt.xa;R=g_opt.xt;O=g_opt.xi;U=g_opt.xb;g=g_opt.xj;o=g_opt.xc}var E=true,y=0;m=q=false;if(typeof r!=="undefined")if(0<r&&r<=7){y=r;switch(y){case 0:case 1:case 2:m=q=false;break;case 3:q=true;m=false;break;case 4:case 5:case 6:case 7:m=q=true;break;default:break}}var b=null,u,a,j,t=0,c=0,fa=0,V=0,F,G,ga=[],S=0,ja,e=0,P=c=0,x=0,d="", H="",z="",J=false,p="";r="";a:for(u=f;u<=n;++u){b=Editor.GetLineStr(u);if(b==null)return false;a=0;for(f=b.length;a<f;++a)switch(e){case 0:if(60==b.charCodeAt(a)){if(R&&S){AddFuncInfoBoth(F,G,d,ja);S=0;d=""}j=f-a;if(2<=j){if(47==b.charCodeAt(a+1))if(3<=j&&s(b.charAt(a+2))){if(3!=x){p="終了タグが不正な位置で出現しました";e=10;break a}F=u;G=a;++a;e=3}else{p="終了タグ名が不正です";e=10;break a}else if(63== b.charCodeAt(a+1)){e=7;if(6<=j&&b.substr(a+2,3)=="xml"&&w(b.charCodeAt(a+5))){if(0==x){if(0==y)y=2;x=1;Q&&AddFuncInfoBoth(u,a,"XML宣言",t)}else{p="文書の最初以外でXML宣言をしました";e=10;break a}a+=5}else if(3<=j&&s(b.charAt(a+2))){Q&&AddFuncInfoBoth(u,a,"処理命令",t);++a;if(0==x)x=1}else{p="処理命令の識別子が不正です";e=10;break a}}else if(37==b.charCodeAt(a+1)){++a; e=8}else if(33==b.charCodeAt(a+1))if(4<=j&&45==b.charCodeAt(a+2)&&45==b.charCodeAt(a+3)){a+=3;e=4;if(0==x)x=1;j=b.substr(a).indexOf("sol-opt:");if(j!=-1){o=B(b.substr(a+j+8,30).match(/^[a-zA-Z0-9\/]*/)[0]);ea=o.e;M=o.w;Q=o.p;N=o.a;R=o.t;O=o.i;U=o.b;g=o.j;o=o.c}}else if(9<=j&&91==b.charCodeAt(a+2)&&b.substr(a+3,6)=="CDATA["){if(0==x)x=1;a+=8;e=6}else if(9<=j&&w(b.charCodeAt(a+9))&&(b.substr(a+2,7)=="DOCTYPE"||0==y|4==y&&b.substr(a+2,7).toUpperCase()=="DOCTYPE"))if(2>x){x=2;Q&&AddFuncInfoBoth(u,a,"文書型宣言", t);if(b.substr(a+2,7)!="DOCTYPE"){y=6;q=m=true}a+=9;c=0;P=5;e=1}else{p="文書型宣言(!DOCTYPE)の位置が不正です";e=10;break a}else{p="文書型宣言(!DOCTYPE)外でマークアップ宣言をしました";e=10;break a}else if(0<j-1&&s(b.charAt(a+1))){F=u;G=a;e=2;E=true;d="";if(3>x)x=3;else if(4<=x){p="要素の位置が不正です。ルート要素の外に要素は置けません。"; e=10;break a}}else{p="要素名が不正です";e=10;break a}if(3!=e&&J&&m){z="";J=false}}else{p="要素名が不正です";e=10;break a}}else if(3!=x&&K(b.charCodeAt(a))){p="普通の文字が要素外に現れました";e=10;break a}else if(S==1&&R){S=2;if(!U)if(d.length<fa)d+=" ";for(j=a;j<f&&b.charCodeAt(j)!=60&&b.charCodeAt(j)!=10&&b.charCodeAt(j)!=13;++j)if(d.length<fa)d+=b.charCodeAt(j)==9?" ":b.charAt(j); else break}else{if(J&&m){z="";J=false}if(a+15<f||0==a){j=0==a?b.indexOf("<")-1:b.substr(a+1).indexOf("<");a=0<=j?j+a:f}}break;case 1:if(K(b.charCodeAt(a))){e=P;P=0;--a}break;case 2:if(w(b.charCodeAt(a))&&6!=c&&7!=c&&9!=c){P=e;e=1;++c;if(c==12)c=9;if(!(3==c||5==c)&&d.length<255&&N|0==t)d+=" ";continue}switch(c){case 0:case 1:case 8:case 9:case 10:case 11:case 2:case 3:if(62==b.charCodeAt(a)&&!((c==2||c==3)&&!m)){if(0==t){if((0==y||2==y||4==y)&&(-1!=d.indexOf(' xmlns="http://www.w3.org/1999/xhtml"')|| -1!=d.indexOf(" xmlns='http://www.w3.org/1999/xhtml'"))){y=3;m=false;q=true}if(!N){c=d.indexOf(" ");if(-1!=c)d=d.substr(0,c)}}c=d.length;1<=c&&47==d.charCodeAt(c-1)&&--c;1<=c&&32==d.charCodeAt(c-1)&&--c;if(d.length!=c)d=d.substr(0,c);c=false;if(0<a&&47!=b.charCodeAt(a-1)||0==a)c=true;j=true;if(m){var C=d,ha=C.indexOf(" ");if(-1!=ha)C=C.substr(0,ha);else ha=d.length;if(O)C=C.toLowerCase();if(c&&D(C)){c=false;J=true;z=C}if("script"==C||"style"==C){e=9;z=C;j=false;c=true}}var ia;if(c)ia={nLine:F,nOffset:G, pszText:d};if(U)d="<"+d+">";if(R&&c&&j){S=1;ja=t;fa=d.length+40}else{AddFuncInfoBoth(F,G,d,t);d=""}if(c){ga.push(ia);++t;if(128<=t){p="階層が最大値に達したため中止します";e=10;break a}}else if(0==t)x=4;if(e==2)e=0;c=0;ia=null;continue}else if(47==b.charCodeAt(a)&&!((c==2||c==3)&&!m)){if(!(a+1<f&&62==b.charCodeAt(a+1))){p='タグ終端の"/"の後ろに>以外の不正な文字が出現しました:tag '+ d;e=10;break a}c=10}else if(0==c){if(0<f-a&&!i(b.charAt(a))){p="要素名の後ろに不正な文字が出現しました:["+b.charAt(a)+"]:tag "+d;e=10;break a}}else if(11==c){if(E&&M&&!A(b.charAt(a))){AddFuncInfoBoth(u,a,'warning: HTML属性"'+b.charAt(a)+'"は"か\'で囲う必要があります',t);E=false}}else if(2==c||3==c)if(61==b.charCodeAt(a))c=4;else{if(3==c||!i(b.charAt(a)))if(3==c&&m){if(N)d+= " ";c=2}else{p="属性名の後ろに不正な文字が出現しました:["+b.charAt(a)+"] tag "+d;e=10;break a}}else if(0<f-a&&s(b.charAt(a))){if(8==c){p="属性値の後ろに不正な文字が出現しました:["+b.charAt(a)+"] tag "+d;e=10;break a}c=2}else{p="タグ中で不正な文字が出現しました:tag "+d;e=10;break a}break; case 4:case 5:if(34==b.charCodeAt(a))c=6;else if(39==b.charCodeAt(a))c=7;else if(m){if(!A(b.charAt(a)))if(M&&E){AddFuncInfoBoth(u,a,'warning: HTML属性値"'+b.charAt(a)+'"は"か\'で囲う必要があります',t);E=false}c=11}else{p=60==b.charCodeAt(a)||62==b.charCodeAt(a)||61==b.charCodeAt(a)?"属性値が不正です:tag "+d:"属性値は\"か'で囲う必要があります:tag "+ d;e=10;break a}break;case 6:if(34==b.charCodeAt(a))c=8;break;case 7:if(39==b.charCodeAt(a))c=8;break;default:p="Program error. switch(nSubMode) default: nSubMode="+c+" tag="+d;e=10;break a}if((6==c||7==c)&&60==b.charCodeAt(a)){p='属性値の中に"<"が出現しました:tag '+d;e=10;break a}if(c==0||N||0==t){if(d.length<255)d+=b.charAt(a);if(L(b.charCodeAt(a))){++a;if(a<f&&d.length<255)d+=b.charAt(a);else d=d.substr(0,d.length-1)}}break;case 3:if(w(b.charCodeAt(a))){c= 1;P=e;e=1}else if(62==b.charCodeAt(a)){e=ga.pop();d=e.pszText;c=d.indexOf(" ");if(-1!=c)d=d.substr(0,c);else c=d.length;if(m&&O){d=d.toLowerCase();H=H.toLowerCase()}if(m&&J&&z==d){J=false;z=""}else if(c!=V&&d!=H){p="終了タグが要素名と一致しません :"+H;u=F;a=G;r=" 開始タグ: "+e.pszText;F=e.nLine;G=e.nOffset;e=11;break a}if(q)if(g&&"script"==H)js_OutlineExec(t,e.nLine+1,u,0,0);else o&&"style"==H&&css_OutlineExec(t,e.nLine+ 1,u,0,0);--t;1<=t||(x=4);H=d="";e=c=V=0}else if(1==c){p="終了タグ名が不正です:スペースの後ろに再度文字が現れました";e=10;break a}else if(60==b.charCodeAt(a)||47==b.charCodeAt(a)){p='終了タグが閉じられる前に"<"または"/"が出現しました';e=10;break a}else if(0<f-a&&i(b.charAt(a))){if(V<255){H+=b.charAt(a); ++V}}else{p="終了タグ名が不正です:["+b.charAt(a)+"]はタグに使えない文字です";e=10;break a}break;case 4:if(45==b.charCodeAt(a))if(3<=f-a&&"--\>"==b.substr(a,3)){E=true;a+=2;e=0}else{if(2<=f-a&&"--"==b.substr(a,2))if(M&&E){E=false;AddFuncInfoBoth(u,a,'warning: コメント中に"--"が出現しました',t)}}else if(0==a){j=b.indexOf("--");a=0<=j?j-1:f}break;case 5:if(0<=c&& c<=3)if(w(b.charCodeAt(a))){if(0==c)if(0==y)if("html"==d){m=q=true;y=4}else{if("HTML"==d.toUpperCase()){m=q=true;y=6}}else if(2==y)if("html"==d){q=true;m=false;y=3}d+=" ";c+=1;P=e;e=1}else d+=b.charAt(a);else if(3==c){d+=b.charAt(a);if(34==b.charCodeAt(a))c=4;else if(39==b.charCodeAt(a))c=5;else{M&&AddFuncInfoBoth(u,a,"warning: DTD宣言が不正です",t);c=9}}else if(4==c){d+=b.charAt(a);if(34==b.charCodeAt(a))c=6}else if(5==c){d+=b.charAt(a);if(39==b.charCodeAt(a))c=6}else if(6== c)if(62==b.charCodeAt(a)){d="";e=c=0}else{if(91==b.charCodeAt(a))c=8}else if(93==b.charCodeAt(a)&&8==c)c=9;else if(9==c)if(62==b.charCodeAt(a)){d="";e=c=0}break;case 6:if(0==a){j=b.indexOf("]]\>");a=0<=j?j-1:f}else if(3<=f-a&&93==b.charCodeAt(a)&&"]>"==b.substr(a+1,2)){a+=2;e=0}break;case 7:if(2<=f-a&&63==b.charCodeAt(a)&&62==b.charCodeAt(a+1)){++a;e=0}break;case 8:if(2<=f-a&&37==b.charCodeAt(a)&&62==b.charCodeAt(a+1)){++a;e=0}break;case 9:if(60==b.charCodeAt(a)&&2+z.length<=f-a&&47==b.charCodeAt(a+ 1)&&(O&&b.substr(a+2,z.length).toLowerCase()==z||!O&&b.substr(a+2,z.length)==z)&&(62==b.charCodeAt(a+2+z.length)||w(b.charCodeAt(a+2+z.length)))){--a;e=0;z=""}else if(0==a){j=b.indexOf("</");a=0<=j?j-1:f}break}}if(ea)if(10==e||11==e){AddFuncInfoBoth(u,a,"error: "+p,0);11==e&&AddFuncInfoBoth(F,G,r,0)}else if(0!=t){AddFuncInfoBoth(u,0,"error: 開始タグ数と終了タグ数が異なります",0);n=ga.pop();r=" 開始タグ: "+n.pszText; AddFuncInfoBoth(n.nLine,n.nOffset,r,0)}else 0!=e&&AddFuncInfoBoth(u,0,"error: タグが閉じられていません(Mode:"+e+")",0);if(q){n="";if(g)n+="/JS";if(o)n+="/CSS";if(m)Outline.SetTitle("XML"+n+"アウトライン(+HTML)");else q&&Outline.SetTitle("XML"+n+"アウトライン(+XHTML)")}else Outline.SetTitle("XMLアウトライン");return true}
function js_OutlineExec(g,f,n,q,m){var r=/\bfunction\b/,B=/[\/\'\"\{\}]|(function\b)/,s,i,w,K=0,L=[],D=0,A=false,I,k,h;k=-1;k=null;for(s=f;s<=n;++s){i=Editor.GetLineStr(s);if(i==null)return false;h=0;if(s==n)i=i.substr(0,m);if(K==1)if(-1!=(k=i.indexOf("*/"))){K=0;h=k+2}else continue;if(s==f&&0<q)h=q-1;w=i.length;for(I=i;h<w;++h){if(0<h)I=i.substr(h);k=I.search(B);if(-1==k)break;h+=k;k=i.charCodeAt(h);if(47==k){if(47==i.charCodeAt(h+1))break;if(42==i.charCodeAt(h+1)){k=i.substr(h+2).indexOf("*/"); if(-1==k){K=1;break}h+=k+4}else{k=I.substr(0,h+1-(w-I.length));if(-1!=k.search(/[\{\}\[\(\,\:;=<>!\+\-\*\/%\&\^\|\?][ \t\u3000\xa0]*\/$/)||-1!=k.search(/^[ \t\u3000\xa0]*\/$/))if(null!=(k=i.substr(h).match(/^\/(?:\\.|[^\/\r\n])+\/[gimy]{0,4}/)))if(-1!=i.substr(h+k[0].length).search(/^[ \t\u3000\xa0]*([\)\.\]\r\n\{\}\,\:;=<>!\+\-\*\/%\&\^\|\?]|\/\/|\/\*)/))h+=k[0].length-1}}else if(39==k)for(h++;h<w;++h)if(92==i.charCodeAt(h)){++h;if(h<w&&39==i.charCodeAt(h))break}else{if(39==i.charCodeAt(h))break}else if(34== k)for(h++;h<w;++h)if(92==i.charCodeAt(h)){++h;if(h<w&&34==i.charCodeAt(h))break}else{if(34==i.charCodeAt(h))break}else if(102==k){k=0<h?h-1:h;if(r.test(i.substr(k,10))){A=i.substr(h,200);A=" "+i.substring(h-60<0?0:h-60,h).match(/[^\\{\};]*$/)[0]+A;A=A.replace(/[\x00-\x20\xa0\u2000-\u200a\u202f\u205f\u3000\u2028\u2029]+/g," ").substr(1,120);k=h;if(!g_opt.jc){k=i.substr(h+8,200).match(/^[\x00-\x20\xa0\u2000-\u200a\u202f\u205f\u3000\u2028\u2029]*/)[0].length+h+8;if(i.length<=k||10==i.charCodeAt(k)|| 13==i.charCodeAt(k))k=h+8}AddFuncInfoBoth(s,k,A,L.length+g);A=true;h+=7}}else if(123==k)if(A){A=false;L.push(D);D=0}else++D;else if(125==k)if(0==D){if(0<L.length)D=L.pop()}else--D}}return true}
function css_OutlineExec(g,f,n,q,m){var r=null,B,s,i,w=0;for(s=f;s<=n;++s){r=Editor.GetLineStr(s);if(r==null)return false;if(s==f)r=r.substr(q);if(s==n)r=r.substr(0,m);if(w==1)if(-1!=(i=r.indexOf("*/"))){w=0;r.substr(i+2)}else continue;B=r.replace(/\/\*(\*[^\/]|[^\*]\/|[^\*\/])*\*\//,"");if(-1!=(i=B.indexOf("/*"))){w=1;B=B.substr(0,i)}-1!=B.indexOf("{")&&AddFuncInfoBoth(s,0,(" "+r).replace(/[\x00-\x20-\xa0\u2000-\u200a\u202f\u205f\u3000]+/g," ").substr(1,50),g)}return true}
function LoadPluginOptions(){var f=true,g={};g.ld=false;g.vs=f;g.wx=f;g.cv=f;g.xe=f;g.xw=f;g.xp=f;g.xa=f;g.xt=f;g.xi=f;g.xb=f;g.xj=f;g.xc=f;g.jc=f;g_opt=g;if(g_bLoadPluginOption)if(Plugin.GetOption("Option","LoadOption")!="0"){var f=function(m){return"0"!=Plugin.GetOption("Option","OutLine"+m)},n=function(m){return parseInt(Plugin.GetOption("Option","OutLine"+m))};g.ld=true;g.vs=f("ViewStyle");var q=n("WebXmlMode");if(0<=q&&q<=7)g.wx=q;g.cv=f("CSSViewStyle");g.xe=f("XMLe"); g.xw=f("XMLw");g.xp=f("XMLp");g.xa=f("XMLa");g.xt=f("XMLt");g.xi=f("XMLi");g.xb=!f("XMLB");g.xj=f("XMLj");g.xc=f("XMLc");g.jc=n("JSc");g_opt=g}}
function OutLineExec(){LoadPluginOptions();var g=Editor.GetLineCount(0),f=Editor.GetFilename();if(g_opt.vs){Outline.SetListType(3);g_bAddFuncModeTree=true}else{Outline.SetListType(0);g_bAddFuncModeTree=false}if(/\.css$/.test(f)){Outline.SetTitle("CSSアウトライン");if(g_opt.cv){Outline.SetListType(0);g_bAddFuncModeTree=false}css_OutlineExec(0,1,g,0,268435455)}if(/\.js$/.test(f)){Outline.SetTitle("JSアウトライン");js_OutlineExec(0,1,g,0,268435455)}else{Outline.SetTitle("XML/JS/CSSアウトライン"); var n=g_opt.wx;n=0;if(/\.xhtml$/.test(f))n=3;else if(/\.xml$/.test(f))n=2;else if(/\.(svg|mml|xsd|atom)$/.test(f))n=1;else if(/\.(s?)htm(l?)$/.test(f))n=6;xml_OutlineExec(0,1,g,0,268435455,n)}}OutLineExec();
